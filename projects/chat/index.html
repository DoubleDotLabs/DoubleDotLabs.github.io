<!doctype html>
<!--
  Material Design Lite
  Copyright 2015 Google Inc. All rights reserved.
  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at
      https://www.apache.org/licenses/LICENSE-2.0
  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License
-->

<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="description" content="We are developers, for developers.">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Double Dot Labs</title>
    
    <!-- Add to homescreen for Chrome on Android -->
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="icon" sizes="192x192" href="http://doubledotlabs.github.io/images/favicon.png">
    
     <!-- Add to homescreen for Safari on iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="Double Dot Labs">
    <link rel="apple-touch-icon-precomposed" href="http://doubledotlabs.github.io/images/favicon.png">
    
    <!-- Tile icon for Win8 (144x144 + tile color) -->
    <meta name="msapplication-TileImage" content="http://doubledotlabs.github.io/images/favicon.png">
    <meta name="msapplication-TileColor" content="#3372DF">

    <link rel="shortcut icon" href="http://doubledotlabs.github.io/images/favicon.png">

    <!-- SEO: If your mobile URL is different from the desktop URL, add a canonical link to the desktop page https://developers.google.com/webmasters/smartphone-sites/feature-phones -->
    <!--
    <link rel="canonical" href="http://www.example.com/">
    -->

    <!-- Page styles -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:regular,bold,italic,thin,light,bolditalic,black,medium&amp;lang=en">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="https://code.getmdl.io/1.1.1/material.min.css">

    <style>
      #login-panel {
        display: block;
        text-align: center;
        padding-left: calc(10% - 64px);
        padding-right: calc(10% - 64px);
        padding-top: 128px;
        padding-bottom: 128px;
      }  

      #login-button {
        margin: 48px auto 48px auto;  
      }

      #login-notice {
        width: calc(40% + 128px);  
        margin: auto;
      }

      #rooms-panel {
        display: none;
      }

      #rooms-table {
        margin: 48px auto 48px auto;  
        width: calc(30% + 128px);
      }

      #chat-panel {
        display: none;
      }

      #chat-form {
        position: fixed;  
        bottom: 0;
        left: 0;
        right: 0; 
        background-color: #E3F2FD;
        text-align: center;
        height: 64px;
        border-radius: 32px;
        margin: 32px;
      }

      #chat-input {
        width: calc(70% - 72px);  
      }

      #chat-submit {
        margin-left: 8px;  
      }

      .message {
        width: 100%;
        padding: 16px;
      }

      .message-profile {
        height: 64px;
        width: 64px;
        border-radius: 32px;
        background-color: #BDBDBD;  
      }

      .message-text {
        display: inline-block;
        background-color: #212121;
        color: white;
        border-radius: 16px;
        padding: 16px;  
      }

      .message-text:hover {
        background-color: #616161;  
      }
    </style>
  </head>
  <body>
    <div id="login-panel">
      <h2>Login:</h2> 
      <hr>
      <div id="login-button" class="g-signin2"></div>
      <p id="login-notice">Please note: by logging in with your google account, you acknowledge that any information entered into this site is publicly available and that your google account will be associated with any actions you perform. Please be courteous and have respect for other users on this site.</p>
    </div>

    <div id="rooms-panel">
      <div class="mdl-tabs mdl-js-tabs mdl-js-ripple-effect">
        <div class="mdl-tabs__tab-bar">
          <a href="#rooms-view-panel" class="mdl-tabs__tab is-active">Rooms</a>
          <a href="#rooms-settings-panel" class="mdl-tabs__tab">Settings</a>
        </div>
    
        <div class="mdl-tabs__panel is-active" id="rooms-view-panel">
          <table id="rooms-table" class="mdl-data-table mdl-js-data-table mdl-shadow--2dp">
            <thead>
              <tr>
                <th class="mdl-data-table__cell--non-numeric">Room Name</th>
              </tr>
            </thead>
            <tbody id="rooms-table"></tbody>
          </table>
        </div>
        <div class="mdl-tabs__panel" id="rooms-settings-panel">
        </div>
      </div>  
    </div>

    <div id="chat-panel">
      <div id="chat-messages"></div>

      <form id="chat-form">
        <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
          <input id="chat-input" class="mdl-textfield__input" type="text" maxlength="250">
          <label class="mdl-textfield__label" for="sample4">Type a message...</label>
          <span class="mdl-textfield__error">Input is greater than 250 characters!</span>
        </div>

        <button id="chat-submit" class="mdl-button mdl-js-button mdl-button--fab mdl-button--mini-fab mdl-button--colored" type="submit">
          <i class="material-icons">send</i>
        </button>
      </form>  
    </div>


    <script src="https://code.getmdl.io/1.1.1/material.min.js"></script>
    <script src="https://cdn.rawgit.com/visionmedia/page.js/master/page.js"
        background-color: #212121;
        color: white;></script>
    <script src="https://apis.google.com/js/platform.js" async defer></script>

    <!--
      PHP docs:

      Room Lifecycle:
      - creating a room: request url http://doubledotlabs.byethost31.com/index.php?room=[room id]&name=[room name (base64)]
      - existing rooms can be 'added' to a user's account by sharing the room's id (or url?) - a storage method still needs to be created for this
      - rename a room: request url http://doubledotlabs.byethost31.com/index.php?room=[room id]&name=[room name (base64)]
      - get the room log: request url http://doubledotlabs.byethost31.com/index.php?room=[room id] - will return an error if the room is not created - adding the room name will prevent this
      - send a message: request url http://doubledotlabs.byethost31.com/index.php?user=[user id]&room=[room id]&text=[message (base64)] - will return an error if the room is not created - adding the room name will prevent this
      - send an image: request url http://doubledotlabs.byethost31.com/index.php?user=[user id]&room=[room id]&image=[image url (base64)] - will return an error if the room is not created - adding the room name will prevent this
      - delete a room: managed by site admins
    -->
    <script>    
  function createRequest(url, credentials, finishedCallback, errorCallback) {
    var xhr = new XMLHttpRequest();
    if ("withCredentials" in xhr) {
      xhr.open("GET", url, true);
    } else if (typeof XDomainRequest != "undefined") {
      xhr = new XDomainRequest();
      xhr.open("GET", url);
    } else {
      xhr = null;
    }
    xhr.withCredentials = credentials;

    xhr.onload = function() {
      if(xhr.readyState === 4) {
        if(xhr.status === 200 || xhr.status == 0) {
          var response = xhr.responseText;
          if (response.includes('<body>') && response.includes('</body>')) response = response.substring(response.indexOf('<body>') + 6, response.indexOf('</body>'));

          try {
            var obj = JSON.parse(response);
            finishedCallback(obj);  
          } catch(err) {
              errorCallback();
          }
        }
      }
    };

    xhr.onerror = function() {
      errorCallback();
    }

    xhr.send();
    return xhr;
  }

  //google login stuff
  var auth2;
  var googleUser;

  window.onload = function() {
    gapi.load('auth2', initSigninV2);

    document.getElementById('chat-form').addEventListener("submit", function(e) {
      e.preventDefault();
      
    }, false); 
  }

  function initSigninV2() {
    auth2 = gapi.auth2.init({
      client_id: 'CLIENT_ID.apps.googleusercontent.com',
      scope: 'profile'
    });

    auth2.isSignedIn.listen(signinChanged);
    auth2.currentUser.listen(userChanged);

    if (auth2.isSignedIn.get() == true) {
      auth2.signIn();
    }

    refreshValues();
  };

  function signinChanged(val) {
    if (val) {
      if (room) showRoom(room);
      else showRooms();
    }
    else showLogin();
  };

  function userChanged(user) {
    googleUser = user;
    updateGoogleUser();
  };

  function updateGoogleUser() {
    if (googleUser) {
      //update the UI for the current google user
      if (room) showRoom(room);
      else showRooms();
    } else showLogin();
  };


  function refreshValues() {
    if (auth2) {
      googleUser = auth2.currentUser.get();
      updateGoogleUser();

      return googleUser != null;
    } else return false;
  }

  function signOut() {
    if (auth2) {
      auth2.signOut();
      return true;  
    } else return false;
  }

  //UI stuff
  var room;

  function showLogin() {
    if (googleUser) {
      if (room) showRoom(room);
      else showRooms();  
    } else {
      document.getElementById('login-panel').style.display = "block";
      document.getElementById('rooms-panel').style.display = "none";
      document.getElementById('chat-panel').style.display = "none";  
    }
  }

  function showRooms() {
    if (googleUser) {
      document.getElementById('login-panel').style.display = "none";
      document.getElementById('rooms-panel').style.display = "block";
      document.getElementById('chat-panel').style.display = "hidden";

      //TODO: replace with user-specific list of rooms once sign-ij works properly
      createRequest("http://doubledotlabs.byethost31.com/index.php", true, function(obj) {
        var roomsHTML = "";
          
        for (var i = 0; true; i++) {
          if (obj[i] == null) break;
          
          roomsHTML += "<tr onclick=\"showRoom(\'" + obj[i].id + "\');\"><td class=\"mdl-data-table__cell--non-numeric\">" + atob(obj[i].name) + "</td></tr>";
        }
          
        document.getElementById('rooms-table').innerHTML = roomsHTML;
      }, function() {
          alert("Something has gone horribly wrong.");
      });
    }  
  }

  function showRoom(roomId) {
    if (googleUser) {
      document.getElementById('login-panel').style.display = "none";
      document.getElementById('rooms-panel').style.display = "none";
      document.getElementById('chat-panel').style.display = "block";

      createRequest("http://doubledotlabs.byethost31.com/index.php?room=" + roomId, true, function(obj) {          
        for (var i = 0; true; i++) {
          if (obj[i] == null) break;

          var parent = document.getElementById('chat-messages');
          
          createRequest("http://picasaweb.google.com/data/entry/api/user/" + obj[i].user + "?alt=json", false, function(user) {
            var HTML = "<div id=\"message-" + i + "\" class=\"message\"><img class=\"message-profile\" src=\"" + user.entry.gphoto$thumbnail.$t + "\"></img><p class=\"message-text\"><strong>" + user.entry.gphoto$nickname.$t + "</strong><br>" + obj[i].text + "<br>" + obj[i].date + "</p></div>";
            var child = htmlToElement(HTML);

            if (i > parent.childNodes.length - 1) parent.appendChild(child);
            else parent.insertBefore(child, parent.children[i + 1]);

          }, function() {
            console.log("Error fetching info for user" + obj[i].user);
          })

          //TODO: show room content
        }
      }, function() {
      });  
    } 
  }

  function htmlToElement(html) {
    var template = document.createElement('template');
    template.innerHTML = html;
    return template.content.firstChild;
  }

  //UI actions
  function createRoom(id, name) {
    //TODO: create the room
    /*
    createRequest("http://doubledotlabs.byethost31.com/index.php?room=" + id + "&name=" + name, true, function(obj) {          
      for (var i = 0; true; i++) {
        if (obj[i] == null) break;
        //TODO: show a confirmation message
      }
    }, function() {
      console.log("Something has gone horribly wrong.");
    });  
    */
  }

  function sendMessage(message) {
    if (googleUser && room) {
      //TODO: send the message
      /*
      createRequest("http://doubledotlabs.byethost31.com/index.php?user=" + googleUser.getAuthResponse().id_token + "&room=" + room + "&text=" + message, true, function(obj) {          
        for (var i = 0; true; i++) {
          if (obj[i] == null) break;
          //TODO: show a confirmation message
        }
      }, function() {
        console.log("Something has gone horribly wrong.");
      });  
      */
    }  
  }

  function sendImage(url) {
    if (googleUser && room) {
      //TODO: send the image
      /*
      createRequest("http://doubledotlabs.byethost31.com/index.php?user=" + googleUser.getAuthResponse().id_token + "&room=" + room + "&image=" + url, true, function(obj) {          
        for (var i = 0; true; i++) {
          if (obj[i] == null) break;
          //TODO: show a confirmation message
        }
      }, function() {
        console.log("Something has gone horribly wrong.");
      });  
      */
    }  
  }

  window.addEventListener('WebComponentsReady', function() {
    page('/', function(ctx, params) {
      if (googleUser) showRooms();
      else showLogin();
    });
    
    page('/room/:room', function(ctx, params) {
      console.log("Room: " + ctx.params.room);

      room = ctx.params.room;

      if (googleUser) showRoom(ctx.params.room);
      else showLogin();

      //TODO: load the content of the room
      //request url is http://doubledotlabs.byethost31.com/index.php?room=ctx.params.room
    });

    page('/room/:room/:url', function(ctx, params) {
      console.log("Room: " + ctx.params.room);
      console.log("Url: " + ctx.params.url);

      if (googleUser) {
        if (room != ctx.params.room) {
          room = ctx.params.room;  
          showRoom(room);  
        }
        //TODO: load the image url in fullscreen with the chatroom as the return url
      } else showLogin();
    });

    page({
      hashbang: true
    });
  });
    </script>
  </body>
</html>
